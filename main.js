import{k}from"./load.js";import{buildLevel}from"./levels.js";export const SCALE=3;let bgm,currentLevel=0,bgmPlaying=!1;export let playerHealth=3;scene("game",(()=>{layers(["bg","game","ui"],"game"),bgmPlaying||(bgmPlaying=!0,bgm=play("bgm",{volume:.1,loop:!0})),cursor("none"),buildLevel(currentLevel);let e=get("player")[0];function o(e){every("heart",destroy);for(let o=0;o<e;o++)add([sprite("heart"),scale(3),pos(40+63*o,40),layer("ui"),fixed(),"heart"])}if(o(e.hp()),onUpdate("player",(e=>camPos(e.pos))),e.onCollide("cat",(()=>{t()})),e.onCollide("barf",(()=>{t()})),e.onCollide("potion",(a=>{e.heal(1),playerHealth++,play("heal",{volume:.5}),o(e.hp()),a.destroy()})),on("hurt","player",(e=>{e.color=rgb(255,0,0),wait(.5,(()=>e.color=null))})),on("death","player",(()=>{bgm.pause(),bgmPlaying=!1,play("lose"),currentLevel=0,get("cat").forEach((e=>clearInterval(e.meowLoop))),go("gameOver")})),7===currentLevel){let o=get("boss")[0],a=setInterval((()=>{!function(e){add([k.sprite("cats2",{anim:"eliteIdle"}),k.pos(e.x-rand(64,96),e.y-rand(64,96)),k.area(),k.scale(3),k.origin("center"),k.layer("game"),health(5),{aggro:!0,timesFed:0,buffed:!0,moveSpeed:70,growModifier:.5,meowLoop:setInterval((()=>{play("eliteMeow",{volume:.2})}),rand(3e3,6e3))},"cat","elite"])}(o.pos)}),rand(7e3,1e4));o.on("death",(()=>{play("bossDie",{volume:.3}),wait(.25,(()=>play("bossDie",{volume:.3}))),wait(.5,(()=>play("bossDie",{volume:.3}))),clearInterval(a)})),e.on("death",(()=>clearInterval(a)))}let a=get("throw");function l(o){if(!e.inCooldown){e.inCooldown=!0,e.play("throw"),wait(e.cooldownTime,(()=>{e.inCooldown=!1,isKeyDown("w")||isKeyDown("a")||isKeyDown("s")||isKeyDown("d")?e.play("walk"):e.play("idle")}));let a=add([sprite("fish"),pos(e.pos.x,e.pos.y),area(),move(o,300),scale(3),rotate(0),cleanup(),origin("center"),"projectile"]);a.onUpdate((()=>{a.angle+=300*dt()}))}}function t(){if(e.invulnerable)return;play("hit"),playerHealth--,e.hurt(1),e.invulnerable=!0,o(e.hp());let a=setInterval((()=>{e.opacity=1==e.opacity?.4:1}),150);wait(1,(()=>{clearInterval(a),e.opacity=1,e.invulnerable=!1}))}loop(1.5,(()=>{for(let o of a)if(o.aggro&&(o.play("calicoThrow"),o.hp()>0)){let a=add([sprite("fishbone"),pos(o.pos.x,o.pos.y),area(),move(e.pos.angle(o.pos),350),scale(3),rotate(0),origin("center"),"enemyProjectile"]);a.onUpdate((()=>{a.angle-=300*dt()}))}})),onUpdate("cat",(o=>function(o){(o.pos.dist(e.pos)<=500||!0===o.aggro)&&(o.aggro=!0,o.stationary||o.moveTo(e.pos,o.moveSpeed+10),e.pos.x>o.pos.x?o.flipX(!0):o.flipX(!1))}(o))),on("death","cat",(o=>{if(clearInterval(o.meowLoop),o.throwLoop&&clearInterval(o.throwLoop),burp({volume:.4}),play("explode"),o.destroy(),add([sprite("puff",{anim:"puff"}),pos(o.pos.x,o.pos.y),origin("center"),lifespan(.5),scale(8)]),0===get("cat").length){add([sprite("staircase"),scale(5),pos(o.pos.x,o.pos.y),area({width:1,height:1}),origin("center"),layer("bg"),"staircase"]);e.onCollide("staircase",(()=>{play("footsteps"),currentLevel++,go("transition")}))}})),onKeyPress(["w","a","s","d"],(()=>{e.play("walk")})),onKeyRelease(["w","a","s","d"],(()=>{isKeyDown("w")||isKeyDown("a")||isKeyDown("s")||isKeyDown("d")||e.play("idle")})),onKeyDown("a",(()=>{e.move(-150,0)})),onKeyDown("d",(()=>{e.move(150,0)})),onKeyDown("w",(()=>{e.move(0,-150)})),onKeyDown("s",(()=>{e.move(0,150)})),onKeyPress("a",(()=>{e.flipX(!1)})),onKeyPress("d",(()=>{e.flipX(!0)})),onKeyPress("f",(()=>{fullscreen(!isFullscreen())})),onKeyPress("left",(()=>{l(LEFT),e.flipX(!1)})),onKeyPress("right",(()=>{l(RIGHT),e.flipX(!0)})),onKeyPress("up",(()=>{l(UP)})),onKeyPress("down",(()=>{l(DOWN)})),onCollide("cat","projectile",((e,o)=>{destroy(o),e.hp()>1&&play("grow"),e.hurt(1),e.timesFed++,e.scaleTo(3+e.timesFed*e.growModifier)})),onCollide("projectile","wall",(e=>{e.destroy(),add([sprite("puff",{anim:"puff"}),pos(e.pos.x,e.pos.y),scale(3),lifespan(.5),origin("center")])})),onCollide("enemyProjectile","wall",(e=>{e.destroy(),add([sprite("puff",{anim:"puff"}),pos(e.pos.x,e.pos.y),scale(3),lifespan(.5),origin("center")])})),onCollide("enemyProjectile","player",(e=>{e.destroy(),t()})),onCollide("projectile","enemyProjectile",((e,o)=>{e.destroy(),o.destroy(),add([sprite("puff",{anim:"puff"}),pos((o.pos.x+e.pos.x)/2,(o.pos.y+e.pos.y)/2),scale(3),lifespan(.5),origin("center")])})),onCollide("player","elite",((e,o)=>{o.play("eliteAttack")})),onUpdate("cat",(o=>{o.solid=o.pos.dist(e.pos)<=192})),onUpdate("wall",(o=>{o.solid=o.pos.dist(e.pos)<=192}))})),scene("mainMenu",(()=>{add([sprite("splashScreen"),pos(0,0),layer("bg")]);let e=add([text("Press SPACE to Play",{size:40,font:"sink"}),pos(width()/2,height()/2+150),origin("top")]);loop(2,(()=>{e.opacity=1,wait(1,(()=>{e.opacity=0}))})),onKeyPress("space",(()=>{go("intro")})),onKeyPress("f",(()=>{fullscreen(!isFullscreen())}))})),scene("gameOver",(()=>{add([sprite("gameOverScreen"),pos(0,0),layer("bg")]);let e=add([text("Press SPACE to Play Again",{size:25,font:"sink"}),pos(width()/2,height()/2+150),origin("top")]);loop(2,(()=>{e.opacity=1,wait(1,(()=>{e.opacity=0}))})),onKeyPress(["space"],(()=>{go("transition")}))})),scene("transition",(()=>{0===currentLevel&&(playerHealth=3),currentLevel<8?(add([pos(0,0),color(0,0,0),rect(width(),height(),{fill:!0}),layer("game")]),add([text(currentLevel<7?`Layer ${currentLevel+1}`:"The Wizard's Lair",{font:"sink",size:40}),pos(camPos().x,camPos().y),origin("center"),layer("ui"),fixed(),stay(),lifespan(2.5,{fade:1})]),wait(1.5,(()=>go("game")))):(bgm.pause(),bgmPlaying=!1,wait(1.5,(()=>go("win"))))})),scene("intro",(()=>{let e=play("introMusic",{volume:.1});add([sprite("intro1"),pos(0,0),layer("bg"),lifespan(5,{fade:1})]),add([text("SPACE to skip",{size:20,font:"sinko"}),pos(width()-250,height()-30),origin("left"),lifespan(3,{fade:1})]),wait(5,(()=>{add([sprite("intro2"),pos(0,0),layer("bg"),lifespan(5,{fade:1})])})),wait(10,(()=>{add([sprite("intro3"),pos(0,0),layer("bg"),lifespan(5,{fade:1})])})),wait(15,(()=>{add([sprite("intro4"),pos(0,0),layer("bg"),lifespan(5,{fade:1})])})),wait(20,(()=>{add([sprite("intro5"),pos(0,0),layer("bg"),lifespan(5,{fade:1})])})),wait(25,(()=>{add([sprite("intro6"),pos(0,0),layer("bg")]);let e=add([text("Press SPACE to Play",{size:40,font:"sinko"}),pos(width()/2,height()/2+200),origin("top")]);loop(2,(()=>{e.opacity=1,wait(1,(()=>{e.opacity=0}))}))})),onKeyPress("space",(()=>{go("transition"),e.pause()})),onKeyPress("f",(()=>{fullscreen(!isFullscreen())}))})),scene("win",(()=>{play("explode"),play("win",{volume:.6}),play("bgm",{volume:.3,loop:!0}),add([sprite("winScreen"),pos(0,0),layer("bg")]),onKeyPress("space",(()=>{go("mainMenu")}))})),go("mainMenu");